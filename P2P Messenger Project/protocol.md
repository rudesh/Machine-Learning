# Epyks networking protocol

Data definitions:
* client ID - an [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier)
    * used for identifying other clients
    * generated by each with Python's [uuid](https://docs.python.org/3/library/uuid.html) module
    * should be unique enough
* client name
    * displayed to other clients so users don't have to identify each other by ID only
    * chosen by the user
    * not necessarily unique
* message ID - an UUID

Packet format: packet type (1 byte) + payload

## Peer discovery
Goal:
1. Get a list of other clients: IP, port, ID, name.
2. Announce itself to other clients: IP, port, ID, name.
 
### Local
Based on UDP multicast, which reaches however far the routers pass UDP multicast packets.

Client opens UDP port (any port number) to listen to. Must allow receiving UDP multicast.

#### Packets
##### LOCAL_QUERY
* Where? UDP multicast
* What? -
* When? on startup to get a list of other clients
* Others' reaction? send LOCAL_ANNOUNCE

##### LOCAL_ANNOUNCE
* Where? UDP multicast
* What? ID, name, public key
* When? on startup to indicate joining, regularly to indicate presence, client receives LOCAL_QUERY
* Others' reaction? remember peer: UDP IP, UDP port, ID, name, public key, UTC timestamp

### Internet
Based on a public tracker, which aggregates clients and helps with [UDP hole punching](https://en.wikipedia.org/wiki/UDP_hole_punching):
* https://web.archive.org/web/20110810233331/http://www.h-online.com/security/features/How-Skype-Co-get-round-firewalls-747197.html
* http://www.brynosaurus.com/pub/net/p2pnat/
* https://en.wikipedia.org/wiki/Hairpinning

Should be easier than [TCP hole punching](https://en.wikipedia.org/wiki/TCP_hole_punching) or other methods.

Tracker has known IP/hostname and UDP port.

#### Packets
##### TRACKER_QUERY
* Where? tracker's UDP port
* What? -
* When? on startup to get a list of other clients, regularly to update list of other clients
* Tracker's reaction? send TRACKER_QUERY_REPLY

##### TRACKER_QUERY_REPLY
* Where? client's UDP port
* What? list of: UDP IP, UDP port, ID, name, public key, UTC timestamp
* When? tracker receives TRACKER_QUERY
* Client's reaction? remember peers: UDP IP, UDP port, ID, name, public key, UTC timestamp

##### TRACKER_ANNOUNCE
* Where? tracker's UDP port
* What? ID, name, public key
* When? on startup to indicate joining, regularly to indicate presence
* Tracker's reaction? remember peer: UDP IP, UDP port, ID, name, public key, UTC timestamp; reply with TRACKER_ANNOUNCE_OK

##### TRACKER_ANNOUNCE_OK
* Where? client's UDP port
* What? UTC timestamp
* When? tracker receives TRACKER_ANNOUNCE
* Client's reaction? -

TODO TRACKER_ANNOUNCE_RELAY ?

##### TRACKER_PUNCH_TO
* Where? tracker's UDP port
* What? peer ID
* When? to hole punch to peer
* Tracker's reaction? send TRACKER_PUNCH_FROM to peer

##### TRACKER_PUNCH_FROM
* Where? client's UDP port
* What? UDP IP, UDP port, ID, name
* When? tracker receives TRACKER_PUNCH_TO
* Client's reaction? send PEER_INIT to peer

TODO hole punching reply ?

## Peer communication
Goal:
1. Start direct P2P connection to another client.
2. Send and receive messages from an established P2P connection.

Local UDP port used for sending and receiving packets to and from peers as well.

TODO encryption

#### Packets
##### PEER_INIT
* Where? peer's UDP port
* What? ID, name, public key
* When? to initiate peer connection, especially when UDP hole punching
* Peer's reaction? -

##### PEER_MESSAGE
* Where? peer's UDP port
* What? message ID, sending UTC timestamp, message
* When? user writes and sends message
* Peer's reaction? show received message, reply with PEER_MESSAGE_OK

##### PEER_MESSAGE_OK
* Where? peer's UDP port
* What? message ID, receiving UTC timestamp
* When? client receives PEER_MESSAGE
* Peer's reaction? mark sent message as received by peer